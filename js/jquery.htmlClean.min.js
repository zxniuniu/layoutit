(function(d){d.fn.htmlClean=function(A){return this.each(function(){var B=d(this);if(this.value){this.value=d.htmlClean(this.value,A)}else{this.innerHTML=d.htmlClean(this.innerHTML,A)}})};d.htmlClean=function(F,B){B=d.extend({},d.htmlClean.defaults,B);var G=/(<(\/)?(\w+:)?([\w]+)([^>]*)>)|<!--(.*?--)>/gi;var L=/([\w\-]+)=(".*?"|'.*?'|[^\s>]*)/gi;var T;var N=new s();var E=[N];var H=N;var M=false;if(B.bodyOnly){if(T=/<body[^>]*>((\n|.)*)<\/body>/i.exec(F)){F=T[1]}}F=F.concat("<xxx>");var Q;while(T=G.exec(F)){var V=T[6]?new j("--",null,T[6],B):new j(T[4],T[2],T[5],B);var I=F.substring(Q,T.index);if(I.length>0){var D=H.children[H.children.length-1];if(H.children.length>0&&o(D=H.children[H.children.length-1])){H.children[H.children.length-1]=D.concat(I)}else{H.children.push(I)}}Q=G.lastIndex;if(V.isClosing){if(w(E,[V.name])){E.pop();H=E[E.length-1]}}else{var A=new s(V);var C;while(C=L.exec(V.rawAttributes)){if(C[1].toLowerCase()=="style"&&B.replaceStyles){var J=!V.isInline;for(var P=0;P<B.replaceStyles.length;P++){if(B.replaceStyles[P][0].test(C[2])){if(!J){V.render=false;J=true}H.children.push(A);E.push(A);H=A;V=new j(B.replaceStyles[P][1],"","",B);A=new s(V)}}}if(V.allowedAttributes!=null&&(V.allowedAttributes.length==0||d.inArray(C[1],V.allowedAttributes)>-1)){A.attributes.push(new a(C[1],C[2]))}}d.each(V.requiredAttributes,function(){var W=this.toString();if(!A.hasAttribute(W)){A.attributes.push(new a(W,""))}});for(var O=0;O<B.replace.length;O++){for(var S=0;S<B.replace[O][0].length;S++){var R=typeof(B.replace[O][0][S])=="string";if((R&&B.replace[O][0][S]==V.name)||(!R&&B.replace[O][0][S].test(T))){V.rename(B.replace[O][1]);O=B.replace.length;break}}}var K=true;if(!H.isRoot){if(H.tag.isInline&&!V.isInline){if(K=n(E)){H=E[E.length-1]}}else{if(H.tag.disallowNest&&V.disallowNest&&!V.requiredParent){K=false}else{if(V.requiredParent){if(K=w(E,V.requiredParent)){H=E[E.length-1]}}}}}if(K){H.children.push(A);if(V.toProtect){while(tagMatch2=G.exec(F)){var U=new j(tagMatch2[3],tagMatch2[1],tagMatch2[4],B);if(U.isClosing&&U.name==V.name){A.children.push(RegExp.leftContext.substring(Q));Q=G.lastIndex;break}}}else{if(!V.isSelfClosing&&!V.isNonClosing){E.push(A);H=A}}}}}return d.htmlClean.trim(y(N,B).join(""))};d.htmlClean.defaults={bodyOnly:true,allowedTags:[],removeTags:["basefont","center","dir","font","frame","frameset","iframe","isindex","menu","noframes","s","strike","u"],allowedAttributes:[],removeAttrs:[],allowedClasses:[],format:false,formatIndent:0,replace:[[["b","big"],"strong"],[["i"],"em"]],replaceStyles:[[/font-weight:\s*bold/i,"strong"],[/font-style:\s*italic/i,"em"],[/vertical-align:\s*super/i,"sup"],[/vertical-align:\s*sub/i,"sub"]],allowComments:false};function h(D,C,B,A){if(!D.tag.isInline&&B.length>0){B.push("\n");for(i=0;i<A;i++){B.push("\t")}}}function y(E,K){var B=[],H=E.attributes.length==0,C;if(E.tag.isComment){if(K.allowComments){B.push("<!--");B.push(E.tag.rawAttributes);B.push(">");if(K.format){h(E,K,B,C-1)}}}else{var F=this.name.concat(E.tag.rawAttributes==undefined?"":E.tag.rawAttributes);var J=E.tag.render&&(K.allowedTags.length==0||d.inArray(E.tag.name,K.allowedTags)>-1)&&(K.removeTags.length==0||d.inArray(E.tag.name,K.removeTags)==-1);if(!E.isRoot&&J){B.push("<");B.push(E.tag.name);d.each(E.attributes,function(){if(d.inArray(this.name,K.removeAttrs)==-1){var L=RegExp(/^(['"]?)(.*?)['"]?$/).exec(this.value);var M=L[2];var N=L[1]||"'";if(this.name=="class"&&K.allowedClasses.length>0){M=d.grep(M.split(" "),function(O){return d.grep(K.allowedClasses,function(P){return P==O||(P[0]==O&&(P.length==1||d.inArray(E.tag.name,P[1])>-1))}).length>0}).join(" ")}if(M!=null&&(M.length>0||d.inArray(this.name,E.tag.requiredAttributes)>-1)){B.push(" ");B.push(this.name);B.push("=");B.push(N);B.push(M);B.push(N)}}})}if(E.tag.isSelfClosing){if(J){B.push(" />")}H=false}else{if(E.tag.isNonClosing){H=false}else{if(!E.isRoot&&J){B.push(">")}var C=K.formatIndent++;if(E.tag.toProtect){var G=d.htmlClean.trim(E.children.join("")).replace(/<br>/ig,"\n");B.push(G);H=G.length==0}else{var G=[];for(var D=0;D<E.children.length;D++){var A=E.children[D];var I=d.htmlClean.trim(c(o(A)?A:A.childrenToString()));if(r(A)){if(D>0&&I.length>0&&(x(A)||f(E.children[D-1]))){G.push(" ")}}if(o(A)){if(I.length>0){G.push(I)}}else{if(D!=E.children.length-1||A.tag.name!="br"){if(K.format){h(A,K,G,C)}G=G.concat(y(A,K))}}}K.formatIndent--;if(G.length>0){if(K.format&&G[0]!="\n"){h(E,K,B,C)}B=B.concat(G);H=false}}if(!E.isRoot&&J){if(K.format){h(E,K,B,C-1)}B.push("</");B.push(E.tag.name);B.push(">")}}}if(!E.tag.allowEmpty&&H){return[]}}return B}function w(A,B){return k(A,function(C){return d.inArray(C.tag.nameOriginal,B)>-1})}function n(A){return k(A,function(B){return B.isRoot||!B.tag.isInline})}function k(A,D,B){B=B||1;var C=A[A.length-B];if(D(C)){return true}else{if(A.length-B>0&&k(A,D,B+1)){A.pop();return true}}return false}function s(A){if(A){this.tag=A;this.isRoot=false}else{this.tag=new j("root");this.isRoot=true}this.attributes=[];this.children=[];this.hasAttribute=function(B){for(var C=0;C<this.attributes.length;C++){if(this.attributes[C].name==B){return true}}return false};this.childrenToString=function(){return this.children.join("")};return this}function a(A,B){this.name=A;this.value=B;return this}function j(B,D,C,A){this.name=B.toLowerCase();this.nameOriginal=this.name;this.render=true;this.init=function(){if(this.name=="--"){this.isComment=true;this.isSelfClosing=true}else{this.isComment=false;this.isSelfClosing=d.inArray(this.name,l)>-1;this.isNonClosing=d.inArray(this.name,t)>-1;this.isClosing=(D!=undefined&&D.length>0);this.isInline=d.inArray(this.name,u)>-1;this.disallowNest=d.inArray(this.name,q)>-1;this.requiredParent=e[d.inArray(this.name,e)+1];this.allowEmpty=d.inArray(this.name,b)>-1;this.toProtect=d.inArray(this.name,g)>-1}this.rawAttributes=C;this.requiredAttributes=z[d.inArray(this.name,z)+1];if(A){if(!A.tagAttributesCache){A.tagAttributesCache=[]}if(d.inArray(this.name,A.tagAttributesCache)==-1){var E=m[d.inArray(this.name,m)+1].slice(0);for(var G=0;G<A.allowedAttributes.length;G++){var F=A.allowedAttributes[G][0];if((A.allowedAttributes[G].length==1||d.inArray(this.name,A.allowedAttributes[G][1])>-1)&&d.inArray(F,E)==-1){E.push(F)}}A.tagAttributesCache.push(this.name);A.tagAttributesCache.push(E)}this.allowedAttributes=A.tagAttributesCache[d.inArray(this.name,A.tagAttributesCache)+1]}};this.init();this.rename=function(E){this.name=E;this.init()};return this}function x(A){while(p(A)&&A.children.length>0){A=A.children[0]}if(!o(A)){return false}var B=c(A);return B.length>0&&d.htmlClean.isWhitespace(B.charAt(0))}function f(A){while(p(A)&&A.children.length>0){A=A.children[A.children.length-1]}if(!o(A)){return false}var B=c(A);return B.length>0&&d.htmlClean.isWhitespace(B.charAt(B.length-1))}function o(A){return A.constructor==String}function r(A){return o(A)||A.tag.isInline}function p(A){return A.constructor==s}function c(A){return A.replace(/&nbsp;|\n/g," ").replace(/\s\s+/g," ")}d.htmlClean.trim=function(A){return d.htmlClean.trimStart(d.htmlClean.trimEnd(A))};d.htmlClean.trimStart=function(A){return A.substring(d.htmlClean.trimStartIndex(A))};d.htmlClean.trimStartIndex=function(A){for(var B=0;B<A.length-1&&d.htmlClean.isWhitespace(A.charAt(B));B++){}return B};d.htmlClean.trimEnd=function(A){return A.substring(0,d.htmlClean.trimEndIndex(A))};d.htmlClean.trimEndIndex=function(B){for(var A=B.length-1;A>=0&&d.htmlClean.isWhitespace(B.charAt(A));A--){}return A+1};d.htmlClean.isWhitespace=function(A){return d.inArray(A,v)!=-1};var u=["a","abbr","acronym","address","b","big","br","button","caption","cite","code","del","em","font","hr","i","input","img","ins","label","legend","map","q","s","samp","select","option","param","small","span","strike","strong","sub","sup","tt","u","var"];var q=["h1","h2","h3","h4","h5","h6","p","th","td","object"];var b=["th","td"];var e=[null,"li",["ul","ol"],"dt",["dl"],"dd",["dl"],"td",["tr"],"th",["tr"],"tr",["table","thead","tbody","tfoot"],"thead",["table"],"tbody",["table"],"tfoot",["table"],"param",["object"]];var g=["script","style","pre","code"];var l=["area","base","br","col","command","embed","hr","img","input","keygen","link","meta","param","source","track","wbr"];var t=["!doctype","?xml"];var m=[["class"],"?xml",[],"!doctype",[],"a",["accesskey","class","href","name","title","rel","rev","type","tabindex"],"abbr",["class","title"],"acronym",["class","title"],"blockquote",["cite","class"],"button",["class","disabled","name","type","value"],"del",["cite","class","datetime"],"form",["accept","action","class","enctype","method","name"],"input",["accept","accesskey","alt","checked","class","disabled","ismap","maxlength","name","size","readonly","src","tabindex","type","usemap","value"],"img",["alt","class","height","src","width"],"ins",["cite","class","datetime"],"label",["accesskey","class","for"],"legend",["accesskey","class"],"link",["href","rel","type"],"meta",["content","http-equiv","name","scheme","charset"],"map",["name"],"optgroup",["class","disabled","label"],"option",["class","disabled","label","selected","value"],"q",["class","cite"],"script",["src","type"],"select",["class","disabled","multiple","name","size","tabindex"],"style",["type"],"table",["class","summary"],"th",["class","colspan","rowspan"],"td",["class","colspan","rowspan"],"textarea",["accesskey","class","cols","disabled","name","readonly","rows","tabindex"],"param",["name","value"],"embed",["height","src","type","width"]];var z=[[],"img",["alt"]];var v=["Â "," ","\t","\n","\r","\f"]})(jQuery);